<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>订单管理</title>
  <style>
    body {
      font-family: "Microsoft YaHei", Arial, sans-serif;
      background: #f7f8fa;
      margin: 0;
      padding: 0;
    }
    .container {
      margin: 30px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px #f0f1f2;
      padding: 24px;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    .toolbar select, .toolbar input {
      height: 32px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      padding: 0 8px;
      font-size: 14px;
    }
    .toolbar button, .toolbar .btn {
      height: 36px;
      background: #1677ff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0 18px;
      font-size: 15px;
      cursor: pointer;
      margin-right: 8px;
    }
    .toolbar .btn-secondary {
      background: #fff;
      color: #1677ff;
      border: 1px solid #1677ff;
    }
    .toolbar .btn-danger {
      background: #fff;
      color: #ff4d4f;
      border: 1px solid #ff4d4f;
    }
    .toolbar .btn-red {
      background: #fff;
      color: #ff4d4f;
      border: 1px solid #ff4d4f;
      font-weight: bold;
      margin-left: 16px;
      box-shadow: 0 0 0 2px #ff4d4f22;
    }
    .search-bar {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .search-bar input {
      width: 220px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      margin-bottom: 16px;
    }
    th, td {
      border: 1px solid #f0f0f0;
      padding: 8px 12px;
      text-align: center;
      font-size: 14px;
    }
    th {
      background: #f5f7fa;
      font-weight: 600;
    }
    tr:nth-child(even) {
      background: #fafbfc;
    }
    .action-link {
      color: #1677ff;
      cursor: pointer;
      margin-right: 8px;
    }
    .action-link:last-child {
      margin-right: 0;
      color: #ff4d4f;
    }
    .pagination {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      font-size: 14px;
    }
    .pagination select {
      height: 28px;
      font-size: 14px;
    }
    .pagination .page-btn {
      border: 1px solid #d9d9d9;
      background: #fff;
      border-radius: 4px;
      padding: 2px 10px;
      cursor: pointer;
      margin: 0 2px;
    }
    .pagination .active {
      background: #1677ff;
      color: #fff;
      border: 1px solid #1677ff;
    }
    .pagination .ellipsis {
      padding: 0 6px;
      color: #999;
    }
    
    /* 弹窗样式 */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
    }
    
    .modal-content {
      position: relative;
      background: #fff;
      width: 90%;
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: bold;
    }
    
    .close-btn {
      font-size: 24px;
      cursor: pointer;
      color: #999;
    }
    
    .filter-section {
      margin-bottom: 20px;
      padding: 15px;
      background: #fafafa;
      border-radius: 4px;
    }
    
    .filter-section input[type="date"] {
      height: 32px;
      border: 1px solid #d9d9d9;
      border-radius: 4px;
      padding: 0 8px;
      margin-right: 10px;
    }
    
    .modal-footer {
      margin-top: 20px;
      text-align: right;
      padding-top: 10px;
      border-top: 1px solid #f0f0f0;
    }
    
    .highlight-row {
      background-color: #e6f7ff !important;
    }
    
    .warning-text {
      color: #ff4d4f;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="toolbar">
      <button class="btn">+ 新增</button>
      <button class="btn-secondary">导入</button>
      <button class="btn-secondary">导出</button>
      <button class="btn-secondary">列入生产</button>
      <button class="btn-secondary">订单库存存查询</button>
      <button class="btn-danger">批量删除</button>
      <button class="btn-red">需求核准</button>
      <div class="search-bar">
        <input type="text" placeholder="多关键字之间使用空格隔开">
        <button class="btn">查询</button>
        <button class="btn-secondary">重置</button>
        <button class="btn-secondary">展开</button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th><input type="checkbox" id="selectAll"> 全选</th>
          <th>序号</th>
          <th>客户名称</th>
          <th>销售订单编号</th>
          <th>订单类型</th>
          <th>业务员</th>
          <th>物料类别</th>
          <th>物料名称</th>
          <th>物料编号</th>
          <th>订单量</th>
          <th>交货时间</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="orderTableBody">
        <!-- 数据将通过JavaScript动态生成 -->
      </tbody>
    </table>
    <div class="pagination">
      共 6915 条数据
      <select>
        <option>100条/页</option>
      </select>
      <button class="page-btn active">1</button>
      <button class="page-btn">2</button>
      <button class="page-btn">3</button>
      <button class="page-btn">4</button>
      <button class="page-btn">5</button>
      <span class="ellipsis">...</span>
      <button class="page-btn">70</button>
      前往 <input type="text" style="width: 40px;"> 页
    </div>
  </div>

  <!-- 需求核准弹窗 -->
  <div id="approvalModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <div class="modal-title">需求核准</div>
        <span class="close-btn">&times;</span>
      </div>
      
      <div class="filter-section">
        <label>需求日期：</label>
        <input type="date" id="demandDate">
      </div>
      
      <table>
        <thead>
          <tr>
            <th>序号</th>
            <th>需求日期</th>
            <th>物料名称</th>
            <th>同步数量</th>
            <th>订单需求量</th>
            <th>待增订单量</th>
          </tr>
        </thead>
        <tbody id="approvalTableBody">
        </tbody>
      </table>
      
      <div class="modal-footer">
        <button class="btn" id="autoGenerateBtn">自动补充备货订单</button>
        <button class="btn-secondary" id="closeModalBtn">关闭</button>
      </div>
    </div>
  </div>

  <script>
    // 示例数据
    const sampleData = [
      { customer: "上海食品有限公司", orderNo: "20250520090", type: "备库订单", sales: "张三", category: "成品", name: "946盒鲜致牧场牛乳", code: "1197001", quantity: "1000", deliveryDate: "2024-06-15" },
      { customer: "北京商贸有限公司", orderNo: "20250520091", type: "常规订单", sales: "李四", category: "成品", name: "946盒鲜致牧场纯牛奶", code: "1197002", quantity: "2000", deliveryDate: "2024-06-20" },
      { customer: "广州贸易有限公司", orderNo: "20250520092", type: "备库订单", sales: "王五", category: "成品", name: "946盒鲜致牧场酸奶", code: "1197003", quantity: "1500", deliveryDate: "2024-06-25" },
      { customer: "深圳食品有限公司", orderNo: "20250520093", type: "常规订单", sales: "赵六", category: "成品", name: "946盒鲜致牧场高钙奶", code: "1197004", quantity: "3000", deliveryDate: "2024-07-01" },
      { customer: "杭州商贸有限公司", orderNo: "20250520094", type: "备库订单", sales: "钱七", category: "成品", name: "946盒鲜致牧场低脂奶", code: "1197005", quantity: "2500", deliveryDate: "2024-07-05" },
      { customer: "南京贸易有限公司", orderNo: "20250520095", type: "常规订单", sales: "孙八", category: "成品", name: "946盒鲜致牧场有机奶", code: "1197006", quantity: "1800", deliveryDate: "2024-07-10" },
      { customer: "武汉食品有限公司", orderNo: "20250520096", type: "备库订单", sales: "周九", category: "成品", name: "946盒鲜致牧场全脂奶", code: "1197007", quantity: "2200", deliveryDate: "2024-07-15" },
      { customer: "成都商贸有限公司", orderNo: "20250520097", type: "常规订单", sales: "吴十", category: "成品", name: "946盒鲜致牧场脱脂奶", code: "1197008", quantity: "2800", deliveryDate: "2024-07-20" },
      { customer: "重庆贸易有限公司", orderNo: "20250520098", type: "备库订单", sales: "郑十一", category: "成品", name: "946盒鲜致牧场儿童奶", code: "1197009", quantity: "1900", deliveryDate: "2024-07-25" },
      { customer: "西安食品有限公司", orderNo: "20250520099", type: "常规订单", sales: "王十二", category: "成品", name: "946盒鲜致牧场老年奶", code: "1197010", quantity: "2100", deliveryDate: "2024-07-30" }
    ];

    // 初始化表格数据
    function initializeTable() {
      const tbody = document.getElementById('orderTableBody');
      sampleData.forEach((item, index) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" class="row-checkbox"></td>
          <td>${index + 1}</td>
          <td>${item.customer}</td>
          <td>${item.orderNo}</td>
          <td>${item.type}</td>
          <td>${item.sales}</td>
          <td>${item.category}</td>
          <td>${item.name}</td>
          <td>${item.code}</td>
          <td>${item.quantity}</td>
          <td>${item.deliveryDate}</td>
          <td>
            <span class="action-link">编辑</span>
            <span class="action-link">删除</span>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 全选功能
    document.getElementById('selectAll').addEventListener('change', function() {
      const checkboxes = document.getElementsByClassName('row-checkbox');
      for (let checkbox of checkboxes) {
        checkbox.checked = this.checked;
      }
    });

    // 页面加载完成后初始化表格
    window.onload = initializeTable;

    // 模拟预测订单数据
    const forecastData = [
      // 同步数量 > 订单需求量（需要补充订单）
      { date: '', materialName: '946盒鲜致牧场牛乳', materialCode: '1197001', syncQuantity: 5000 },      // 订单量1000
      { date: '', materialName: '946盒鲜致牧场纯牛奶', materialCode: '1197002', syncQuantity: 6000 },    // 订单量2000
      { date: '', materialName: '946盒鲜致牧场酸奶', materialCode: '1197003', syncQuantity: 4500 },      // 订单量1500
      { date: '', materialName: '946盒鲜致牧场高钙奶', materialCode: '1197004', syncQuantity: 5500 },    // 订单量3000
      { date: '', materialName: '946盒鲜致牧场低脂奶', materialCode: '1197005', syncQuantity: 4800 },    // 订单量2500
      
      // 同步数量 < 订单需求量（不需要补充订单）
      { date: '', materialName: '946盒鲜致牧场有机奶', materialCode: '1197006', syncQuantity: 1500 },   // 订单量1800
      { date: '', materialName: '946盒鲜致牧场全脂奶', materialCode: '1197007', syncQuantity: 2000 },    // 订单量2200
      { date: '', materialName: '946盒鲜致牧场脱脂奶', materialCode: '1197008', syncQuantity: 2500 },    // 订单量2800
      { date: '', materialName: '946盒鲜致牧场儿童奶', materialCode: '1197009', syncQuantity: 1800 },    // 订单量1900
      { date: '', materialName: '946盒鲜致牧场老年奶', materialCode: '1197010', syncQuantity: 2000 }     // 订单量2100
    ];

    // 需求核准功能
    document.querySelector('.btn-red').addEventListener('click', function() {
      const selectedRows = document.querySelectorAll('.row-checkbox:checked');
      if (selectedRows.length === 0) {
        alert('请先选择销售订单');
        return;
      }
      
      // 显示弹窗
      const modal = document.getElementById('approvalModal');
      modal.style.display = 'block';
      
      // 设置默认日期为今天
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('demandDate').value = today;
      
      // 更新预测数据中的日期
      forecastData.forEach(item => {
        item.date = today;
      });
      
      // 初始化核准列表
      updateApprovalList(today);
    });

    // 更新核准列表
    function updateApprovalList(date) {
      const tbody = document.getElementById('approvalTableBody');
      tbody.innerHTML = '';
      
      // 获取选中订单的物料需求量
      const selectedOrders = Array.from(document.querySelectorAll('.row-checkbox:checked'))
        .map(checkbox => {
          const row = checkbox.closest('tr');
          return {
            materialName: row.cells[7].textContent,
            materialCode: row.cells[8].textContent,
            quantity: parseInt(row.cells[9].textContent) || 0
          };
        });
      
      // 按物料汇总订单需求量
      const orderDemands = selectedOrders.reduce((acc, order) => {
        const key = `${order.materialName}_${order.materialCode}`;
        if (!acc[key]) {
          acc[key] = {
            materialName: order.materialName,
            materialCode: order.materialCode,
            totalQuantity: 0
          };
        }
        acc[key].totalQuantity += order.quantity;
        return acc;
      }, {});
      
      // 获取预测数据
      const forecastItems = forecastData.filter(item => item.date === date);
      
      // 生成核准列表
      const approvalItems = forecastItems.map((item, index) => {
        const key = `${item.materialName}_${item.materialCode}`;
        const orderDemand = orderDemands[key] ? orderDemands[key].totalQuantity : 0;
        const pendingQuantity = Math.max(0, item.syncQuantity - orderDemand);
        
        return {
          ...item,
          orderDemand,
          pendingQuantity
        };
      });
      
      // 按待增订单量排序
      approvalItems.sort((a, b) => b.pendingQuantity - a.pendingQuantity);
      
      // 渲染列表
      approvalItems.forEach((item, index) => {
        const tr = document.createElement('tr');
        if (item.pendingQuantity > 0) {
          tr.classList.add('highlight-row');
        }
        
        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${item.date}</td>
          <td>${item.materialName}</td>
          <td>${item.syncQuantity}</td>
          <td>${item.orderDemand}</td>
          <td>
            <input type="number" value="${item.pendingQuantity}" 
                   ${item.pendingQuantity <= 0 ? 'disabled' : ''} 
                   class="pending-quantity" 
                   data-material="${item.materialName}"
                   data-code="${item.materialCode}"
                   data-date="${item.date}">
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // 自动补充备货订单
    document.getElementById('autoGenerateBtn').addEventListener('click', function() {
      const pendingItems = Array.from(document.querySelectorAll('.pending-quantity'))
        .filter(input => parseInt(input.value) > 0);
      
      if (pendingItems.length === 0) {
        alert('没有需要补充的订单');
        return;
      }
      
      // 获取现有订单数据
      const existingOrders = Array.from(document.getElementById('orderTableBody').children)
        .map(row => ({
          materialName: row.cells[7].textContent,
          materialCode: row.cells[8].textContent,
          deliveryDate: row.cells[10].textContent,
          row: row
        }));

      // 生成备货订单
      pendingItems.forEach(item => {
        const deliveryDate = new Date(item.dataset.date);
        deliveryDate.setHours(23, 59, 0);
        const formattedDate = formatDeliveryDate(deliveryDate);
        
        // 查找是否存在相同物料和交货时间的订单
        const existingOrder = existingOrders.find(order => 
          order.materialName === item.dataset.material && 
          order.materialCode === item.dataset.code &&
          order.deliveryDate === formattedDate
        );

        if (existingOrder) {
          // 更新现有订单
          existingOrder.row.cells[9].textContent = item.value; // 更新数量
          existingOrder.row.cells[3].textContent = generateOrderNo(); // 更新订单号
        } else {
          // 创建新订单
          const newOrder = {
            customer: "",
            orderNo: generateOrderNo(),
            type: "备货订单",
            sales: "",
            category: "成品",
            name: item.dataset.material,
            code: item.dataset.code,
            quantity: item.value,
            deliveryDate: formattedDate
          };
          
          // 添加到表格
          addOrderToTable(newOrder);
        }
      });
      
      // 关闭弹窗
      document.getElementById('approvalModal').style.display = 'none';
    });

    // 格式化交货日期
    function formatDeliveryDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // 生成订单编号
    function generateOrderNo() {
      const date = new Date();
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
      return `${year}${month}${day}${random}`;
    }

    // 添加订单到表格
    function addOrderToTable(order) {
      const tbody = document.getElementById('orderTableBody');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="checkbox" class="row-checkbox"></td>
        <td>${tbody.children.length + 1}</td>
        <td>${order.customer}</td>
        <td>${order.orderNo}</td>
        <td>${order.type}</td>
        <td>${order.sales}</td>
        <td>${order.category}</td>
        <td>${order.name}</td>
        <td>${order.code}</td>
        <td>${order.quantity}</td>
        <td>${order.deliveryDate}</td>
        <td>
          <span class="action-link">编辑</span>
          <span class="action-link">删除</span>
        </td>
      `;
      tbody.appendChild(tr);
    }

    // 关闭弹窗
    document.querySelector('.close-btn').addEventListener('click', function() {
      document.getElementById('approvalModal').style.display = 'none';
    });
    
    document.getElementById('closeModalBtn').addEventListener('click', function() {
      document.getElementById('approvalModal').style.display = 'none';
    });

    // 日期筛选变化时更新列表
    document.getElementById('demandDate').addEventListener('change', function() {
      updateApprovalList(this.value);
    });
  </script>
</body>
</html> 